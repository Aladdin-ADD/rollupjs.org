<link rel='ractive' href='./BundleOptions.html'>
<link rel='ractive' href='./Module.html'>
<link rel='ractive' href='./Status.html'>
<link rel='ractive' href='./Output.html'>
<link rel='ractive' href='./Blurb.html'>

<div class='left'>
	<select value='{{selectedExample}}'>
		{{#each examples}}
			<option value='{{this}}'>{{name}}</option>
		{{/each}}
	</select>

	{{#each modules :i}}
		<Module module='{{this}}' index='{{i}}' main='{{i===0}}'/>
	{{/each}}

	<button class='mdl-button mdl-js-button new-module' on-tap='createModule()'>new module</button>
</div>

<div class='right'>
	<Status error='{{error}}'/>
	<BundleOptions options='{{options}}'/>
	<Output output='{{output}}'/>
	<Blurb/>
</div>


<style>
	main {
		overflow: hidden;
	}

	.left, .right {
		width: 50%;
		height: 100%;
		float: left;
	}

	.new-module {
		float: right;
	}
</style>

<script>
	import { dirname, resolve, extname } from './utils/path';
	import tap from 'ractive-events-tap';

	component.exports = {
		data: () => ({
			error: null,
			options: {
				format: 'amd',
				moduleName: 'bundle'
			},
			modules: [
				{
					name: 'main.js',
					code: `import { foo } from './foo';\nconsole.log( foo() );`
				},

				{
					name: 'foo.js',
					code: `export function foo () {\n\treturn 42;\n}`
				}
			]
		}),

		oninit () {
			this.observe({
				modules: modules => {
					console.log( 'modules', modules );
					this.renderModules( modules, this.get( 'options' ) );
				},

				options: options =>Â {
					console.log( 'options', options );
					this.renderModules( this.get( 'modules' ), options );
				},

				selectedExample: example => {
					const modules = Object.keys( example.modules ).map( key => {
						return {
							name: `${key}.js`,
							code: example.modules[ key ]
						};
					});

					modules.sort( ( a, b ) => {
						if ( a.name === 'main.js' ) return -1;
						if ( b.name === 'main.js' ) return 1;

						return a.name < b.name ? -1 : 1;
					});

					this.set({ modules });
				}
			});
		},

		renderModules ( modules, options ) {
			let moduleById = {};

			modules.forEach( module => {
				moduleById[ module.name ] = module;
			});

			rollup.rollup({
				entry: '@main',
				resolveId ( importee, importer ) {
					if ( !importer ) return importee;
					if ( importee[0] !== '.' ) return undefined;
					return resolve( dirname( importer ), importee );
				},
				load: function ( id ) {
					if ( id === '@main' ) return modules[0].code;
					if ( id.substr( 0, 2 ) === './' ) id = id.substring( 2 );

					if ( extname( id ) === '' ) {
						id += '.js';
					}

					const module = moduleById[ id ];

					if ( !module ) throw new Error( `missing module ${id}` ); // TODO...

					return module.code;
				}
			}).then( bundle => {
				console.log( 'bundle', bundle )
				const generated = bundle.generate( options );

				this.set( 'output', generated.code );
				this.set( 'error', null );
			})
			.catch( error => this.set( 'error', error ) );
		},

		removeModule ( index ) {
			this.splice( 'modules', index, 1 );
		},

		createModule () {
			this.push( 'modules', {
				name: 'newModule.js',
				contents: ''
			});

			const view = this.findAllComponents( 'Module' ).pop();
			view.find( 'input' ).select();
		},

		events: {
			tap
		}
	};
</script>
