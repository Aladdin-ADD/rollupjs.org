<link rel='ractive' href='./Module.html'>
<link rel='ractive' href='./Status.html'>
<link rel='ractive' href='./Output.html'>

<div class='left'>
	<div class='format-selection'>
		<p>Bundle format:</p>
		[[#formats : i]]
		<label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="format-[[value]]">
		  <input type="radio" id="format-[[value]]" class="mdl-radio__button" name="{{format}}" value="[[value]]"/>
		  <span class="mdl-radio__label">[[name]]</span>
		</label>
		[[/formats]]
	</div>

	{{#each modules :i}}
		<Module module='{{this}}' index='{{i}}' main='{{i===0}}'/>
	{{/each}}

	<button class='mdl-button mdl-js-button new-module' on-tap='createModule()'>new module</button>
</div>

<div class='right'>
	<Status error='{{error}}'/>
	<Output output='{{output}}'/>
</div>


<style>
	main {
		overflow: hidden;		
	}

	.left, .right {
		width: 50%;
		height: 100%;
		float: left;
	}

	.new-module {
		float: right;
	}

	.format-selection {
		margin: 0 20px 20px 20px;
	}

	.format-selection > label {
		margin-right: 20px;
	}

	.format-selection > p {
		margin: 0;
	}
</style>

<script>
	const path = require( './interop/path' );

	component.exports = {
		data: () => ({
			error: null,
			formats: [
				{ name: 'AMD', value: 'amd' },
				{ name: 'CommonJS', value: 'cjs' },
				{ name: 'ES2015', value: 'es6' },
				{ name: 'Globals', value: 'iife' },
				{ name: 'UMD', value: 'umd' }
			],
			format: 'amd',
			modules: [
				{
					name: 'main.js',
					code: `import { foo } from './foo';\nconsole.log( foo() );`
				},

				{
					name: 'foo.js',
					code: `export function foo () {\n\treturn 42;\n}`
				}
			]
		}),

		oninit () {
			this.observe( 'modules', modules => {
				console.log( 'modules', modules );
				this.renderModules( modules, this.get( 'format' ) );
			});

			this.observe( 'format', format => {
				console.log( 'format', format );
				this.renderModules( this.get( 'modules' ), format );
			});
		},

		renderModules ( modules, format ) {
			let moduleById = {};

			modules.forEach( module => {
				moduleById[ module.name ] = module;
			});

			rollup.rollup({
				entry: '@main',
				resolveId ( importee, importer ) {
					if ( !importer ) return importee;
					if ( importee[0] !== '.' ) return undefined;
					return path.resolve( path.dirname( importer ), importee );
				},
				load: function ( id ) {
					if ( id === '@main' ) return modules[0].code;
					if ( id.substr( 0, 2 ) === './' ) id = id.substring( 2 );

					const module = moduleById[ id + '.js' ];

					if ( !module ) throw new Error( `missing module ${id}` ); // TODO...

					return module.code;
				}
			}).then( bundle => {
				console.log( 'bundle', bundle )
				const generated = bundle.generate({
					format
				});

				this.set( 'output', generated.code );
				this.set( 'error', null );
			})
			.catch( error => this.set( 'error', error ) );
		},

		removeModule ( index ) {
			this.splice( 'modules', index, 1 );
		},

		createModule () {
			this.push( 'modules', {
				name: 'newModule.js',
				contents: ''
			});

			const view = this.findAllComponents( 'Module' ).pop();
			view.find( 'input' ).select();
		},

		events: {
			tap: require( 'ractive-events-tap' )
		}
	};
</script>
