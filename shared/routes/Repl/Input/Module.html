<article class='module {{main ? "main-module" : ""}}'>
	<header>
		{{#if main}}
			<span class='entry-module-name'>main.js <span class='entry-module-label'>(entry module)</span></span>
		{{else}}
			<input class='module-name' bind:value='name' placeholder='foo.js'>

			<button class='remove' on:click='fire("remove")'>
				<span class='label'>remove</span>
				<span class='icon-cancel'></span>
			</button>
		{{/if}}
	</header>

	<div class='mirror-container'>
		<div ref:mirrorInner class='mirror-container-inner'>
			<div class='gutters'></div>
			<div class='selection'>
				<div class='cursor' ref:cursor/>
				<div ref:selA style='height: 23px;'/>
				<div ref:selB style='width: 100%; left: 0;'/>
				<div ref:selC style='left: 0; height: 23px;'/>
			</div>
			<div ref:measure class='measure'></div>

			<textarea ref:textarea bind:value='code' on:blur='blur()' spellcheck='{{false}}'/>
			<pre class='mirror' ref:mirror spellcheck='false'/>
		</div>
	</div>
</article>

<style>
	.module {
		margin: 0 0 1em 0;
		border: 1px solid #f4f4f4;
	}

	header {
		width: 100%;
		border-bottom: 1px solid #f4f4f4;
	}

	.main-module {
		border: 1px solid #ccc;
	}

	.main-module header {
		/*background-color: #f4f4f4;*/
	}

	.entry-module-name {
		display: block;
		padding: 0.5em;
	}

	.entry-module-label {
		color: #999;
	}

	button {
		position: absolute;
		top: 0;
		right: 0;
		font-family: inherit;
		font-size: inherit;
		padding: 0.5em;
		background-color: transparent;
		border: none;
		color: #e94c43;
		cursor: pointer;
		outline: none;
		opacity: 0.4;
		-webkit-transition: opacity 0.2s;
		transition: opacity 0.2s;
	}

	button:hover, button:active {
		opacity: 1;
	}

	button .label {
		position: absolute;
		right: 100%;
		opacity: 0;
		-webkit-transition: opacity 0.2s;
		transition: opacity 0.2s;
	}

	button:hover .label, button:active .label {
		opacity: 0.6;
	}

	.icon-cancel {
		font-size: 0.8em;
	}

	.mirror-container {
		position: relative;
		max-height: 300px;
		overflow-x: hidden;
		overflow-y: auto;
	}

	.mirror-container-inner {
		padding: 0 0 0 32px;
	}

	.gutters {
		position: absolute;
		left: 0;
		top: 0;
		width: 32px;
		height: 100%;
		background-color: #f9f9f9;
		border-right: 1px solid #eee;
	}

	.selection {
		top: -2px;
	}

	.selection > div, .measure {
		position: absolute;
	}

	.selection > div {
		background-color: rgb(200,200,220);
	}

	.cursor {
		width: 1px;
		height: 26px;
		background-color: #333;
		animation-name: blink;
		animation-duration: 1.2s;
		animation-iteration-count: infinite;
	}

	.measure {
		white-space: pre-wrap;
		pointer-events: none;
		padding-left: 6px;
		color: transparent;
		font-family: 'Inconsolata', monospace;
		line-height: 1.4;
		font-size: 16px;
	}

	.mirror {
		padding: 5px;
		font-size: 16px;
		line-height: 1.4;
		white-space: pre-wrap;
		pointer-events: none;
		color: #333;
		overflow-x: visible;
		margin: 0;
	}

	.line::before {
		position: absolute;
		content: attr(data-linenum);
		width: 2em;
		text-align: right;
		left: -3em;
		color: #999;
	}

	textarea {
		position: absolute;
		width: calc(100% - 32px);
		height: 100%;
		font-family: 'Inconsolata', monospace;
		font-size: 16px;
		border: none;
		resize: none;
		padding: 5px;
		line-height: 1.4;
		outline: none;
		color: rgba(200,0,0,0.4);
		opacity: 0;
	}

	@keyframes blink {
		0% { opacity: 1; }
		40% { opacity: 1; }
		50% { opacity: 0; }
		90% { opacity: 0; }
		100% { opacity: 1; }
	}
</style>

<script>
	import { getLocator, locate } from 'locate-character';

	if ( typeof window !== 'undefined' ) {
		window.editors = [];
	}

	export default {
		oncreate () {
			let updating = false;

			this.refs.textarea.value = this.get( 'code' );

			this.refs.textarea.addEventListener( 'scroll', () => {
				this.refs.mirrorInner.scrollTop = this.refs.textarea.scrollTop;
			});

			// const editor = CodeMirror.fromTextArea( this.refs.textarea, {
			// 	lineNumbers: true,
			// 	lineWrapping: true
			// });

			// editor.on( 'change', instance => {
			// 	if ( !updating ) {
			// 		updating = true;
			// 		this.set({ code: instance.getValue() });
			// 		updating = false;
			// 	}
			// });

			// window.editors.push( editor );

			// this.observe( 'code', code => {
			// 	if ( !updating && code != null ) {
			// 		updating = true;
			// 		editor.setValue( code );
			// 		updating = false;
			// 	}
			// });

			this.mirror();

			document.addEventListener( 'selectionchange', event => {
				if ( this.refs.textarea !== document.activeElement ) {
					return;
				}

				const { selectionStart, selectionEnd } = this.refs.textarea;

				if ( selectionStart === selectionEnd ) {
					this.showCursor( selectionStart );
					this.hideSelection();
				} else {
					this.hideCursor();
					this.showSelection( selectionStart, selectionEnd );
				}
			});
		},

		methods: {
			mirror () {
				console.group( 'mirroring' );
				this.refs.mirror.innerHTML = this.refs.textarea.value.split( '\n' )
					.map( ( line, i ) => {
						return `<div class='line' data-linenum='${i + 1}'>${line || '&nbsp;'}</div>`;
					})
					.join( '' );
				console.groupEnd();
			},

			getCoords ( char ) {
				const code = this.get( 'code' );
				const lines = code.split( '\n' );
				const loc = locate( code, char );

				const lineElement = this.refs.mirror.children[ loc.line ];

				this.refs.measure.innerHTML = ( lines[ loc.line ] + ' ' )
					.split( '' )
					.map( char => `<span>${char}</span>` )
					.join( '' );

				const spans = this.refs.measure.children;
				const span = spans[ loc.column ];

				return {
					top: ~~( lineElement.offsetTop + span.offsetTop ),
					left: ~~( lineElement.offsetLeft + span.offsetLeft ) - 7
				};
			},

			hideCursor () {
				this.refs.cursor.style.display = 'none';
			},

			hideSelection () {
				this.refs.selA.style.display = this.refs.selB.style.display = this.refs.selC.style.display = 'none';
			},

			showCursor ( char ) {
				const { top, left } = this.getCoords( char );

				Object.assign( this.refs.cursor.style, {
					display: 'block',
					top: ( top - 2 ) + 'px',
					left: left + 'px'
				});
			},

			showSelection ( start, end ) {
				const code = this.get( 'code' );
				const locate = getLocator( code );
				const lines = code.split( '\n' );

				const startLoc = locate( start );
				const endLoc = locate( end );

				const startLineElement = this.refs.mirror.children[ startLoc.line ];
				const endLineElement = this.refs.mirror.children[ endLoc.line ];

				this.refs.measure.style.top = startLineElement.offsetTop;
				this.refs.measure.innerHTML = ( lines[ startLoc.line ] + ' ' )
					.split( '' )
					.map( char => `<span>${char}</span>` )
					.join( '' );

				let spans = this.refs.measure.children;
				let char = spans[ startLoc.column ];

				const startTop = startLineElement.offsetTop + char.offsetTop;
				const startLeft = endLineElement.offsetLeft + char.offsetLeft;

				if ( endLineElement !== startLineElement ) {
					this.refs.measure.style.top = endLineElement.offsetTop;
					this.refs.measure.innerHTML = ( lines[ endLoc.line ] + ' ' )
						.split( '' )
						.map( char => `<span>${char}</span>` )
						.join( '' );

					spans = this.refs.measure.children;
				}

				char = spans[ endLoc.column ];
				if ( !char ) {
					console.log( `endLoc`, endLoc )
				}

				const endTop = endLineElement.offsetTop + char.offsetTop;
				const endLeft = endLineElement.offsetLeft + char.offsetLeft;

				Object.assign( this.refs.selA.style, {
					display: 'block',
					top: startTop + 'px',
					left: ( startLeft - 7 ) + 'px'
				});

				if ( startTop === endTop ) {
					// same line
					this.refs.selA.style.right = 'auto';
					this.refs.selA.style.width = ( endLeft - startLeft ) + 'px';

					this.refs.selB.style.display = this.refs.selC.style.display = 'none';
				} else {
					this.refs.selA.style.right = 0;
					this.refs.selA.style.width = 'auto';

					this.refs.selC.style.top = endTop;
					this.refs.selC.style.width = endLeft + 'px';

					if ( endTop > startTop + 23 ) {
						// three lines
						Object.assign( this.refs.selB.style, {
							display: 'block',
							top: startTop + 23,
							height: endTop - ( startTop + 23 )
						});
					} else {
						// two lines
						this.refs.selB.style.display = 'none';
					}

					this.refs.selC.style.display = 'block';
				}
			},

			blur () {
				this.hideSelection();
				this.hideCursor();
			}
		}
	};
</script>
